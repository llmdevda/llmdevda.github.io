---
title: "OpenR1实战(2)--数据准备"
date: 2025-05-21
categories: ["实战", "教程"]
tags: [llm, grpo, openr1]
---

上一节我们速览了open r1的源码，了解了怎么使用。

这次我们要使用数据来执行SFT。

如果只是想要复现open r1的实验，可以下载它的数学题训练集[OpenR1-Math-220k](https://huggingface.co/datasets/open-r1/OpenR1-Math-220k)

里面包含了450K的数学题数据

内容是下面这样的表格
```
problem: 问题2。一家四口章鱼来到一家鞋店（每只章鱼有8条腿）。章鱼爸爸已经有一半的腿被踢了脚，章鱼妈妈只有3条腿被踢了脚，他们的两个儿子各有6条腿被踢了脚。如果他们离开商店时已经穿好了靴子，他们会买多少靴子？

solution: <think>Okay，让我看看。有一个四口之家的章鱼去一家鞋店。每只章鱼有8条腿。问题是，如果他们离开商店时已经....</think>.［\\boxed{13}\\］

answer: 13
```

# 诗歌训练
然而，数学题的思维链（CoT）较长，训练过程非常耗时，且数据集规模庞大，不适合作为实验测试用例，也不便以公司项目为例。

因此，**我选择了唐诗数据集作为展示实验**：一方面避免了版权问题，另一方面也可以探索强化学习在文学类任务中的效果。

**目标是制作一个可以接诗句的模型**

数据集类似下面这个格式
```
problem: <system> 你是一个写诗机器人，用户给出绝句前三句，你接最后一句。只要回复最后一句</system> 天马斜飞度三止，上将横行击四方。辎车直入无迴翔，

solution: <think><CoT（思维链）的部分> </think> 六甲次第不乖行

answer: 六甲次第不乖行

yun: 七阳韵
```

唐诗近体诗，需要符合平仄和韵的限制

> ### 平仄的限制  
> 1. **基本规则**：  
>    - 平仄交替：单句内平仄声调需交替出现（如“平平仄仄平平仄”）。  
>    - 平仄相对：上下句同一位置声调需相反（如出句为“仄”，对句应为“平”）。  
> 2. **常见格式**：  
>    - 五言：仄起式、平起式（如“仄仄平平仄，平平仄仄平”）。  
>    - 七言：在五言基础上增加“平平”或“仄仄”（如“平平仄仄平平仄，仄仄平平仄仄平”）。  
> 
> ### 韵的限制  
> 1. **押韵位置**：偶数句末尾通常需押韵，首句可押可不押（如唐诗）。  
> 2. **用韵范围**：需在同一“韵部”内选字（古用《平水韵》，今可参考《中华新韵》），不允许> 跨韵部混押。  
> 

平仄这个很简单，我们主要说说押韵。

通常来说，绝句的第二句末尾和第四句末尾字需要押韵。

诗歌押韵不仅仅是要声母相近，还得让字在所处的韵表里。（古体诗没有这个标准，一些更现代的诗也会放开这个标准。）

比如上面例子中的七阳韵，就是由下面字组成的
> 七阳平声　香 长 光 阳 凉 乡 堂 霜 方 黄 章 肠 忘 茫 忙 郎 场 芳 伤 狂 觞 苍 床 荒 行 [行列]裳 王 常 梁 藏 墙 房 妆 翔 桑 亡 塘 扬 央 皇 傍 [通旁]良 量 [衡量]强 [刚强]张 囊 尝 冈 羊 ...

因为行（hang），在其中，因此这首诗是押韵的。

为了简化，我们限制诗歌为七言绝句。

七言表示每句七个字，绝句表示诗歌总共四句。

**我们强化学习目标就是七言绝句的平仄和韵。**

比如
```log
Q: 水作青龙盘石堤，桃花夹岸鲁门西。若教月下乘舟去
答案1       : 应有仙人吹笛啼。 
评价        | 0.8571428571428571 1.0 七言绝句(仄起平收式) 八齐韵 第26字 [笛] 不符合仄

答案2       : 应是仙人放鹤归。 
评价        | 1.0 0.0 七言绝句(仄起平收式) 八齐韵 第27字 [归] 不符合平韵

答案3       : 一棹烟波去未迷。 
评价        | 1.0 1.0 七言绝句(仄起平收式) 八齐韵 
```


## 无CoT数据集
没有CoT的数据集很简单，

直接由问句——诗歌前三句，以及对应诗句——绝句最后一句，和所处韵组成

```
system: 你是一个写诗机器人，用户给出绝句前三句，你接最后一句。只要回复最后一句

problem: 天马斜飞度三止，上将横行击四方。辎车直入无迴翔，

answer: 六甲次第不乖行

yun: 七阳韵
```


## 包含CoT思维链的数据集
而包含CoT（思维链）的数据则困难很多，我们需要生成每一个问题的模型思维

### 直接蒸馏Reason模型
跟open r1一样，直接对DeepSeek的开源模型进行蒸馏，获取其CoT。

比如如下

```
System: 你是一个写诗机器人，用户给出绝句前三句，你接最后一句。只要回复最后一句
User: 天马斜飞度三止，上将横行击四方。辎车直入无迴翔，
Assistant:
<think>
好的，用户让我接绝句的最后一句。前三句是：

天马斜飞度三止，
上将横行击四方。
辎车直入无迴翔，

首先，我需要理解这前三句的意境和结构。绝句通常是四句，每句五或七个字，这里看起来是七言绝句。前三句描绘的是战争或军事行动的场景，天马、上将、辎车这些意象都和军事有关。

第一句“天马斜飞度三止”中的“天马”可能指战马或神话中的神马，“斜飞”可能指快速移动，“度三止”可能指经过三个关隘或三次停顿？不太确定，可能需要进一步分析。

第二句“上将横行击四方”说明将领率军四方征战，横行有横扫千军的意思。
...

考虑到押韵，前三句的韵脚分别是“止”、“方”、“翔”，可能押的是“ang”或“ing”韵？不过中文古诗有时换韵，但通常一韵到底。这里可能需要检查是否押韵。
...

不过可能用户不太严格要求平仄，只要意境相符即可。所以综合来看，最后一句可能需要点明胜利或结束战斗，比如“功成万古名”或者“功成身自闲”之类的。

再考虑用词，“无迴翔”可能指没有退路，所以最后一句可能强调胜利，比如“直取龙庭”或者“直破敌营”之类的。

综合以上，可能最后一句是“功成万古名”或者“直取龙庭”之类的。不过需要押韵。前三句的韵脚“止”、“方”、“翔”可能不太统一，但最后一句可能需要押“ang”韵，比如“方”、“翔”、“ang”可能押韵，但“止”是“i”韵，可能不太一致。不过古诗有时换韵，但通常一韵。

可能用户更注重意境，所以选择“功成万古名”作为结尾，虽然押韵可能不太严格，但符合整体意境。

</think>
功成万古名
```

显然，这个回答是不对的，不仅【名】字不押韵，而且连字数都对不上。

这时我们就得筛选结果了

**将生成的回答中，韵和平仄都不符合要求的直接排除。**

这个过程会挺费时间的，取决于生成文本的速度，我运行时万条数据大约需要2-3小时

**尤其是未训练的模型，在平仄和韵的方面，正确率很低。**

大约10个结果里只有1个满足要求的。

所以我们需要一些额外处理来优化

### 优化替换蒸馏结果
在分析结果时会发现，很多样本平仄能满足要求，但韵字不符合。

可以将这类样本的韵字替换成合适的韵字。

怎么判断韵字是否合适呢？

简单的做法可以直接选择高频用的韵字。

比如七阳韵中本身虽然有100多个字，但常用的字并不多。

比如，七阳平声　长 光 阳 凉 堂 方 黄

字频本身也可以通过分析唐诗得到，可以结合前后字，和对位字，**以统计概率形式估算合适韵字。**

这样我们可以**把可选的韵字缩小到一个范围**

然后进一步，**通过模型去判断哪个字选择最好**

```
Q: 天马斜飞度三止，上将横行击四方。辎车直入无迴翔，烽火连天照夜__
你觉得哪个字比较好？

(1) - 烽火连天照夜长
(2) - 烽火连天照夜墙
(3) - 烽火连天照夜香
...
```

### 拼接CoT
在训练前的模型，整体生成的诗句并不让人满意。

**最好能将完整的古诗四句让模型去学习，而不是仅靠蒸馏模型的自由发挥。**

为了提升其能力，我们有必要将唐诗的正确答案加入到CoT之中。

**CoT样本里很多的版式是十分接近的。**

我们可以用填空方式让模型生成恰当的CoT。

```
system:
分析诗歌每一句的情景与意象，以及特殊词语的意义。总结全诗意境词。以及末尾字所属韵，和结尾韵字其他可能的词。
按如下格式给出
第一句：xxxxx
第二句：xxxxxx
...

user:
天马斜飞度三止，上将横行击四方。辎车直入无迴翔，

assisant：
好的，我现在需要分析用户提供的这首诗。首先，我得仔细阅读每一句，...
```

最后，将这些生成CoT组合起来，就能得到一个比较全面且足够正确的CoT训练集


# 总结
在进行OpenR1的实验时，我们可以选择它提供的数学数据集。

也可以自己创建数据集与奖励函数来尝试不同的领域问题。

以诗歌绝句为例子，

本文介绍了如何根据蒸馏，优化以及拼接的方式来生成CoT数据集

1. 其中蒸馏是直接将问题提问给Reason模型获取CoT结果，并根据奖励函数筛选正确的数据集

2. 优化则通过规则和统计，将错误的CoT数据，替换成可能正确的几个选项。再通过模型做选择题，来选择最合适的答案。

3. 拼接则是确保原始训练集的答案能被模型完全学习到，通过将答案和问题一起提供给模型，让其生成合适的CoT文本。

将这些生成CoT组合起来，就能得到一个比较全面且足够正确的CoT训练集。

整个过程会比较耗时且繁琐，但数据清洗是每个工程的必经之路

在分析过程中，提早发现奖励函数的问题，也能减少后续训练的问题。
